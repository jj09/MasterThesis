%!TEX root = etdrtemplate.tex

\cleardoublepage

\chapter{Verification}
\label{verification}

\section{Verification of implemented prototype}
\label{verification:prototype}

Examine(F8) -> Simplifier --> POGS.

4 warnings:
Warning 402 - Default assertion planted to cut loop.

solution:
\lstinline{--# assert I > 1 -> TheStoredData(I-1) = TheStoredData(I);}
\lstinline{--# assert I > 1 -> Result >= TheStoredData(I-1);}
\lstinline{--# assert true; // add BLESS assertions? then resolve warning 402?}
\lstinline{--# assert true; // add BLESS assertions? then resolve warning 402?}


Verification of main.adb

\begin{lstlisting}
main.adb:4:10: Warning 391 - If the identifier Text_IO represents a package which contains a task or an interrupt handler then the partition-level analysis performed by the Examiner will be incomplete.  Such packages must be inherited as well as withed.
main.adb:6:10: Warning 391 - If the identifier Float_Text_IO represents a package which contains a task or an interrupt handler then the partition-level analysis performed by the Examiner will be incomplete.  Such packages must be inherited as well as withed.
main.adb:102:5: Warning  10 - The body of subprogram Main is hidden - hidden text is ignored by the Examiner.
main.adb:14:49: Flow Error 602 - The undefined initial value of Pca_Pump.Operate may be used in the derivation of Pca_Pump.State.
main.adb:14:49: Flow Error 602 - The undefined initial value of Pca_Pump.Fluid_Pulses may be used in the derivation of Pca_Pump.State.
main.adb:14:49: Flow Error 602 - The undefined initial value of Pca_Pump.Prescription may be used in the derivation of Pca_Pump.State.
main.adb:14:49: Flow Error 602 - The undefined initial value of Pca_Pump.Clinician_Bolus_Paused may be used in the derivation of Pca_Pump.State.
main.adb:14:49: Flow Error 602 - The undefined initial value of Pca_Pump.Clinician_Bolus_Duration may be used in the derivation of Pca_Pump.State.
main.adb:14:49: Flow Error  37 - The updating of variable Pca_Pump.Operate by a task or interrupt handler has been omitted from the partition annotation.
main.adb:14:49: Flow Error  37 - The updating of variable Pca_Pump.Fluid_Pulses by a task or interrupt handler has been omitted from the partition annotation.
main.adb:14:49: Flow Error  37 - The updating of variable Pca_Pump.Clinician_Bolus_Paused by a task or interrupt handler has been omitted from the partition annotation.
main.adb:14:49: Flow Error  36 - The referencing of variable Pca_Pump.Operate by a task or interrupt handler has been omitted from the partition annotation.
main.adb:14:49: Flow Error  36 - The referencing of variable Pca_Pump.Fluid_Pulses by a task or interrupt handler has been omitted from the partition annotation.
main.adb:14:49: Flow Error  36 - The referencing of variable Pca_Pump.Prescription by a task or interrupt handler has been omitted from the partition annotation.
main.adb:14:49: Flow Error  36 - The referencing of variable Pca_Pump.Clinician_Bolus_Paused by a task or interrupt handler has been omitted from the partition annotation.
main.adb:14:49: Flow Error  36 - The referencing of variable Pca_Pump.Clinician_Bolus_Duration by a task or interrupt handler has been omitted from the partition annotation.
/Volumes/External/VMS/shared/aadl-medical/pca-pump-beagleboard/pca_ravenscar/main.adb:1:1: Warning - VC generation requested but no bodies presented. No VCs generated.
\end{lstlisting}



\section{Verification of generated code}
\label{verification:generated}

An overview of verification contracts and annotations can be found in chapter 12 of Barnes' book \cite{Barnes:Book}.


\subsection{Adding implementation to generated code}
\label{verification:generated:implementation}


\section{Verification of PCA Pump}
\label{verification:pcapump}


\subsection{Monitoring dosed amount}
\label{verification:pcapump:monitoring}

Verification of module responsible for tracking dosed amount of drug.
Isolated to verify, because of Ravenscar limitations.
Sequential.

Code:

\begin{lstlisting}
package Pca_Pump
--# own Dosed;
--#     Dose_Volume;
--# initializes Dosed,
--#             Dose_Volume;
is
    subtype Integer_Array_Index is Integer range 1 .. 60*60;
    type Integer_Array is array (Integer_Array_Index) of Integer;

    procedure Increase_Dosed;
    --# global in out Dosed;
    --#        in Dose_Volume;
    --# derives Dosed from Dosed, Dose_Volume;

    function Read_Dosed return Integer;
    --# global in Dosed;

    procedure Move_Dosed;
    --# global in out Dosed;
    --# derives Dosed from Dosed;

end Pca_Pump;
\end{lstlisting}


\begin{lstlisting}
package body Pca_Pump
is
    Dosed : Integer_Array := Integer_Array'(others => 0);
    Dose_Volume : Integer := 1;

    procedure Increase_Dosed
    is
    begin
        Dosed(Integer_Array_Index'Last) := Dosed(Integer_Array_Index'Last) + Dose_Volume;
    end Increase_Dosed;

    function Read_Dosed return Integer
    is
        Result : Integer := 0;
    begin
        for I in Integer_Array_Index loop
            --# assert I > 1 -> Result >= Dosed(I-1);
            Result := Result + Dosed(I);
        end loop;
        return Result;
    end Read_Dosed;

    procedure Move_Dosed
    is
    begin
        for I in Integer_Array_Index range 1 .. Integer_Array_Index'Last-1 loop
            --# assert I > 1 -> Dosed(I-1) = Dosed(I);
            Dosed(I) := Dosed(I+1);
        end loop;
        Dosed(Integer_Array_Index'Last) := 0;
    end Move_Dosed;

end Pca_Pump;

\end{lstlisting}


Verification with Examiner, Simplifier, Victor, POGS and then Bakar Kiasan.

Examiner:
No errors or warnings

SPARKSimp:
\begin{lstlisting}
gnatspark sparksimp -P/Volumes/External/VMS/shared/aadl-medical/pca-pump-beagleboard/Pca_Verification/pca_verification.gpr
sparksimp -victor
SPARKSimp GPL 2012
Copyright (C) 2012 Altran Praxis Limited, Bath, U.K.
Simplifier  binary located at: /Users/jj/Sireum/apps/spark/2012/bin/spadesimp
ZombieScope binary located at: /Users/jj/Sireum/apps/spark/2012/bin/zombiescope
Victor binary located at: /Users/jj/Sireum/apps/spark/2012/bin/victor

Files to be simplified are:
/Volumes/External/VMS/shared/aadl-medical/pca-pump-beagleboard/Pca_Verification/pca_pump/increase_dosed.dpc, 1474 bytes
/Volumes/External/VMS/shared/aadl-medical/pca-pump-beagleboard/Pca_Verification/pca_pump/increase_dosed.vcg, 1457 bytes
/Volumes/External/VMS/shared/aadl-medical/pca-pump-beagleboard/Pca_Verification/pca_pump/move_dosed.dpc, 6072 bytes
/Volumes/External/VMS/shared/aadl-medical/pca-pump-beagleboard/Pca_Verification/pca_pump/move_dosed.vcg, 9612 bytes
/Volumes/External/VMS/shared/aadl-medical/pca-pump-beagleboard/Pca_Verification/pca_pump/read_dosed.dpc, 3089 bytes
/Volumes/External/VMS/shared/aadl-medical/pca-pump-beagleboard/Pca_Verification/pca_pump/read_dosed.vcg, 5189 bytes

 6 files require processing

Job-ID Status     Filename
====== ======     ========
     1 Started - ZOMBIESCOPE - /Volumes/External/VMS/shared/aadl-medical/pca-pump-beagleboard/Pca_Verification/pca_pump/increase_dosed.dpc
     1 Finished    0: 0: 0.10
     2 Started - SIMPLIFY - /Volumes/External/VMS/shared/aadl-medical/pca-pump-beagleboard/Pca_Verification/pca_pump/increase_dosed.vcg
     2 Finished    0: 0: 0.12
     3 Started - ZOMBIESCOPE - /Volumes/External/VMS/shared/aadl-medical/pca-pump-beagleboard/Pca_Verification/pca_pump/move_dosed.dpc
     3 Finished    0: 0: 0.17
     4 Started - SIMPLIFY - /Volumes/External/VMS/shared/aadl-medical/pca-pump-beagleboard/Pca_Verification/pca_pump/move_dosed.vcg
     4 Finished    0: 0: 0.18
     5 Started - ZOMBIESCOPE - /Volumes/External/VMS/shared/aadl-medical/pca-pump-beagleboard/Pca_Verification/pca_pump/read_dosed.dpc
     5 Finished    0: 0: 0.18
     6 Started - SIMPLIFY - /Volumes/External/VMS/shared/aadl-medical/pca-pump-beagleboard/Pca_Verification/pca_pump/read_dosed.vcg
     6 Finished    0: 0: 0.17
     7 Started - VICTOR - /Volumes/External/VMS/shared/aadl-medical/pca-pump-beagleboard/Pca_Verification/pca_pump/increase_dosed.vcg
     7 Finished    0: 0: 0.08
     8 Started - VICTOR - /Volumes/External/VMS/shared/aadl-medical/pca-pump-beagleboard/Pca_Verification/pca_pump/move_dosed.vcg
     8 Finished    0: 0: 0.02
     9 Started - VICTOR - /Volumes/External/VMS/shared/aadl-medical/pca-pump-beagleboard/Pca_Verification/pca_pump/read_dosed.vcg
     9 Finished    0: 0: 0.36
Total elapsed time:    0: 0: 1.39
[2014-07-01 14:45:00] process terminated successfully (elapsed time: 01.53s)
\end{lstlisting}

POGS Report:

\begin{lstlisting}
-------------------------------------------------------------------------------
                          Semantic Analysis Summary                            
                                POGS GPL 2012                                  
            Copyright (C) 2012 Altran Praxis Limited, Bath, U.K.               
-------------------------------------------------------------------------------

Summary of:

Verification Condition files (.vcg)
Simplified Verification Condition files (.siv)
Victor result files (.vct)
Riposte result files (.rsm)
Proof Logs (.plg)
Dead Path Conjecture files (.dpc)
Summary Dead Path files (.sdp)

"status" column keys:
    1st character:
        '-' - No VC
        'S' - No SIV
        'U' - Undischarged
        'E' - Proved by Examiner
        'I' - Proved by Simplifier by Inference
        'X' - Proved by Simplifier by Contradiction
        'P' - Proved by Simplifier using User Defined Proof Rules
        'V' - Proved by Victor
        'O' - Proved by Riposte
        'C' - Proved by Checker
        'R' - Proved by Review
        'F' - VC is False
    2nd character:
        '-' - No DPC
        'S' - No SDP
        'U' - Unchecked
        'D' - Dead path
        'L' - Live path

in the directory:
/Volumes/External/VMS/shared/aadl-medical/pca-pump-beagleboard/Pca_Verification

Summary produced: 01-JUL-2014 14:43:18.04

File /Volumes/External/VMS/shared/aadl-medical/pca-pump-beagleboard/Pca_Verification/pca_pump/increase_dosed.vcg
procedure Pca_Pump.Increase_Dosed

VCs generated 01-JUL-2014 14:42:26

VCs simplified 01-JUL-2014 14:43:04

File /Volumes/External/VMS/shared/aadl-medical/pca-pump-beagleboard/Pca_Verification/pca_pump/increase_dosed.dpc
DPCs generated 01-JUL-2014 14:42:26

DPC ZombieScoped 01-JUL-2014  14:43:0

VCs for procedure_increase_dosed :
 -----------------------------------------------------------------------------
| #   | From  | To                  | Proved By          | Dead Path | Status |
|-----------------------------------------------------------------------------
| 1   | start | rtc check @ 9       | Undischarged       | Unchecked |   UU   |
| 2   | start |    assert @ finish  | Examiner           | Live      |   EL   |
 -----------------------------------------------------------------------------


File /Volumes/External/VMS/shared/aadl-medical/pca-pump-beagleboard/Pca_Verification/pca_pump/move_dosed.vcg
procedure Pca_Pump.Move_Dosed

VCs generated 01-JUL-2014 14:42:26

VCs simplified 01-JUL-2014 14:43:04

File /Volumes/External/VMS/shared/aadl-medical/pca-pump-beagleboard/Pca_Verification/pca_pump/move_dosed.dpc
DPCs generated 01-JUL-2014 14:42:26

DPC ZombieScoped 01-JUL-2014  14:43:0

VCs for procedure_move_dosed :
 -----------------------------------------------------------------------------
| #   | From  | To                  | Proved By          | Dead Path | Status |
|-----------------------------------------------------------------------------
| 1   | start | rtc check @ 26      | Inference          | Unchecked |   IU   |
| 2   | start | rtc check @ 26      | Inference          | Unchecked |   IU   |
| 3   | start |    assert @ 27      | Inference          | Live      |   IL   |
| 4   | 27    |    assert @ 27      | Inference          | Live      |   IL   |
| 5   | 27    | rtc check @ 28      | Inference          | Unchecked |   IU   |
| 6   | start | rtc check @ 30      | Inference          | Unchecked |   IU   |
| 7   | 27    | rtc check @ 30      | Inference          | Unchecked |   IU   |
| 8   | start |    assert @ finish  | Examiner           | Dead      |   ED   |
| 9   | 27    |    assert @ finish  | Examiner           | Live      |   EL   |
 -----------------------------------------------------------------------------


File /Volumes/External/VMS/shared/aadl-medical/pca-pump-beagleboard/Pca_Verification/pca_pump/read_dosed.vcg
function Pca_Pump.Read_Dosed

VCs generated 01-JUL-2014 14:42:26

VCs simplified 01-JUL-2014 14:43:05

File /Volumes/External/VMS/shared/aadl-medical/pca-pump-beagleboard/Pca_Verification/pca_pump/read_dosed.dpc
DPCs generated 01-JUL-2014 14:42:26

DPC ZombieScoped 01-JUL-2014  14:43:0

VCs for function_read_dosed :
 -----------------------------------------------------------------------------
| #   | From  | To                  | Proved By          | Dead Path | Status |
|-----------------------------------------------------------------------------
| 1   | start |    assert @ 17      | Inference          | Live      |   IL   |
| 2   | 17    |    assert @ 17      | Undischarged       | Live      |   UL   |
| 3   | 17    | rtc check @ 18      | Undischarged       | Unchecked |   UU   |
| 4   | 17    |    assert @ finish  | Inference          | Live      |   IL   |
 -----------------------------------------------------------------------------


===============================================================================
Summary:

The following subprograms have undischarged VCs (excluding those proved false):

   1  /Volumes/External/VMS/shared/aadl-medical/pca-pump-beagleboard/Pca_Verification/pca_pump/increase_dosed.vcg
   2  /Volumes/External/VMS/shared/aadl-medical/pca-pump-beagleboard/Pca_Verification/pca_pump/read_dosed.vcg

Proof strategies used by subprograms
-------------------------------------------------------------------------
Total subprograms with at least one VC proved by examiner:              2
Total subprograms with at least one VC proved by simplifier:            2
Total subprograms with at least one VC proved by contradiction:         0
Total subprograms with at least one VC proved with user proof rule:     0
Total subprograms with at least one VC proved by Victor:                0
Total subprograms with at least one VC proved by Riposte:               0
Total subprograms with at least one VC proved using checker:            0
Total subprograms with at least one VC discharged by review:            0

Maximum extent of strategies used for fully proved subprograms:
-------------------------------------------------------------------------
Total subprograms with proof completed by examiner:                     0
Total subprograms with proof completed by simplifier:                   1
Total subprograms with proof completed with user defined rules:         0
Total subprograms with proof completed by Victor:                       0
Total subprograms with proof completed by Riposte:                      0
Total subprograms with proof completed by checker:                      0
Total subprograms with VCs discharged by review:                        0

Overall subprogram summary:
-------------------------------------------------------------------------
Total subprograms fully proved:                                         1
Total subprograms with at least one undischarged VC:                    2  <<<
Total subprograms with at least one false VC:                           0
                                                                    -----
Total subprograms for which VCs have been generated:                    3


ZombieScope Summary:
-------------------------------------------------------------------------
Total subprograms for which DPCs have been generated:                   3
Total number subprograms with dead paths found:                         1
Total number of dead paths found:                                       1


VC summary:
-------------------------------------------------------------------------
Note: (User) denotes where the Simplifier has proved VCs using one or
      more user-defined proof rules.

Total VCs by type:
------------------
                    Total   Examiner Simplifier    Undisc.
Assert/Post             8          3          4          1
Precondition            0          0          0          0
Check stmnt.            0          0          0          0
Runtime check           7          0          5          2
Refinem. VCs            0          0          0          0
Inherit. VCs            0          0          0          0
==========================================================
Totals:                15          3          9          3 <<<
%Totals:                         20%        60%        20%

===================== End of Semantic Analysis Summary ========================

\end{lstlisting}

pca-pump-verification-step1.png

problem: Integer'First = Integer'Last = 1 :O

solution: added standard.ads:

\begin{lstlisting}
package Standard is

    type Integer is range -2**31 .. 2**31-1;

end Standard;
\end{lstlisting}

pca-pump-verification-step2.png

Introduce type Drug\_Volume
Change \lstinline{Integer_Array} to \lstinline{Doses_Array} because it is not array of integers anymore.

Result: no lower overflow in \lstinline{Increase_Dosed}. Only upper overflow left.

pca-pump-verification-step3.png

Add contract to \lstinline{Increase_Dosed} --# pre Read_Dosed(Dosed) <= Drug_Volume'Last - Dose_Volume;
Examiner Error: Semantic Error   1 - The identifier Read_Dosed is either undeclared or not visible at this point.


Moved \lstinline{Read_Dosed} to be before \lstinline{Increase_Dosed}.
Examiner Error: pca_pump.ads:19:51: Semantic Error  35 - Binary operator is not declared for types Drug_Volume and Dose_Volume__type.

Declared \lstinline{Dose_Volume} type in \lstinline{--# own}: --#     Dose_Volume : Drug_Volume;


\section{AUnit tests}
\label{verification:aunit}
- test incrementing array
- test moving array (Pulse does not change dosed amount)
- test prescription setters and getters
- test state machine
	* change to bolus mode
	* change to KVO rate
	* etc.



\section{gnatPROVE?}
\label{verification:gnatprove}

There is a new tool set "gnatPROVE" for SPARK 2014. It was not used because PCA Pump was developed in SPARK 2005.
I CAN TRANSLATE SOME SINGLE FUNCTIONS AND USE GNAT PROVE TO VERIFY?
